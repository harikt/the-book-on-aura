<!doctype html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="author" content="Hari KT, Paul M Jones" />
    <meta name="date" content="07/08/2013"/>
    <meta name="generator" content="easybook 5.0-DEV"/>

    <title>Validation and Sanitization | The complete reference for Aura</title>

    <link rel="stylesheet" href="./css/easybook.css" />

</head>

<body class="item chapter">
<div class="container">
<div class="menu">
    <div class="row">
        <h1 class="span9"><a href="./index.html">The complete reference for Aura</a></h1>
        <p class="span3">
                        <a href="./chapter-11.html"><span>&larr;</span> Previous</a>
            
                        <a href="./chapter-13.html">Next <span>&rarr;</span></a>
                    </p>
    </div>
</div>

<div class="row">
    <div class="span9">
        <h1 id="validation-and-sanitization"><span>Chapter 12</span> Validation and Sanitization</h1>
        <p>The Aura Filter package provides validation and sanitizing for 
data objects and arrays.</p>

<h2 id="applying-rules-to-data-objects">12.1 Applying Rules to Data Objects</h2>

<h3 id="soft-hard-and-stop-rules">12.1.1 Soft, Hard, and Stop Rules</h3>

<p>There are three types of rule processing we can apply:</p>

<ul>
<li><p>The <code>addSoftRule()</code> method adds a soft rule: if the rule fails, the filter
will keep applying all remaining rules to that field and all other fields.</p></li>
<li><p>The <code>addHardRule()</code> method adds a hard rule: if the rule fails, the filter
will not apply any more rules to that field, but it will keep filtering
other fields.</p></li>
<li><p>The <code>addStopRule()</code> method adds a stopping rule: if the rule fails, the
filter will not apply any more filters to any more fields; this stops all
filtering on the data object.</p></li>
</ul>

<h2 id="validating-and-sanitizing">12.2 Validating and Sanitizing</h2>

<p>We validate data by applying a rule with one of the following requirements:</p>

<ul>
<li><p><code>RuleCollection::IS</code> means the field value must match the rule.</p></li>
<li><p><code>RuleCollection::IS_NOT</code> means the field value must <em>not</em> match the
rule.</p></li>
<li><p><code>RuleCollection::IS_BLANK_OR</code> means the field value must <em>either</em> be
blank, <em>or</em> match the rule. This is useful for optional field values that
may or may not be filled in.</p></li>
</ul>

<p>We sanitize data by applying a rule with one of the following transformations:</p>

<ul>
<li><p><code>RuleCollection::FIX</code> to force the field value to comply with the
rule; this may forcibly transform the value. Some transformations are not
possible, so sanitizing the field may result in an error message.</p></li>
<li><p><code>RuleCollection::FIX_BLANK_OR</code> will convert blank values to <code>null</code>;
non-blank fields will be forced to comply with the rule. This is useful for
sanitizing optional field values that may or may not match the rule.</p></li>
</ul>

<p>Each field is sanitized in place; i.e., the data object property will be
modified directly.</p>

<h2 id="blank-values">12.3 Blank Values</h2>

<p>Aura Filter incorporates the concept of "blank" values, as distinct from
<code>isset()</code> and <code>empty()</code>. A value is blank if it is <code>null</code>, an empty string, or
a string composed of only whitespace characters. Thus, the following are
blank:</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="re0">$blank</span> <span class="sy0">=</span> <span class="br0">&#91;</span>
    <span class="kw4">null</span><span class="sy0">,</span>           <span class="co1">// a null value</span>
    <span class="st_h">''</span><span class="sy0">,</span>             <span class="co1">// an empty string</span>
    <span class="st0">&quot; <span class="es1">\r</span> <span class="es1">\n</span> <span class="es1">\t</span> &quot;</span><span class="sy0">,</span>   <span class="co1">// a whitespace-only string</span>
<span class="br0">&#93;</span><span class="sy0">;</span></pre>
</div>

<p>Integers, floats, booleans, and other non-strings are never counted as blank,
even if they evaluate to zero:</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="re0">$not_blank</span> <span class="sy0">=</span> <span class="br0">&#91;</span>
    <span class="nu0">0</span><span class="sy0">,</span>              <span class="co1">// integer</span>
    <span class="nu19">0.00</span><span class="sy0">,</span>           <span class="co1">// float</span>
    <span class="kw4">false</span><span class="sy0">,</span>          <span class="co1">// boolean false</span>
    <span class="br0">&#91;</span><span class="br0">&#93;</span><span class="sy0">,</span>             <span class="co1">// empty array</span>
    <span class="br0">&#40;</span>object<span class="br0">&#41;</span> <span class="br0">&#91;</span><span class="br0">&#93;</span><span class="sy0">,</span>    <span class="co1">// an object</span>
<span class="br0">&#93;</span><span class="sy0">;</span></pre>
</div>

<h2 id="available-rules">12.4 Available Rules</h2>

<ul>
<li><p><code>alnum</code>: Validate the value as alphanumeric only. Sanitize to leave only
alphanumeric characters. Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'alnum');
</code></pre></li>
<li><p><code>alpha</code>: Validate the value as alphabetic only. Sanitize to leave only
alphabetic characters. Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'alpha');
</code></pre></li>
<li><p><code>between</code>: Validate the value as being within or equal to a minimum and
maximum value. Sanitize so that values lower than the range are forced up
to the minimum; values higher than the range are forced down to the maximum.
Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'between', $max, $min);
</code></pre></li>
<li><p><code>blank</code>: Validate the value as being blank. Sanitize to <code>null</code>. Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'blank');
</code></pre></li>
<li><p><code>bool</code>: Validate the value as being a boolean, or a pseudo-boolean.
Pseudo-true values include the strings '1', 'y', 'yes', and 'true';
pseudo-false values include the strings '0', 'n', 'no', and 'false'.
Sanitize to a strict PHP boolean. Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'bool');
</code></pre></li>
<li><p><code>creditCard</code>: Validate the value as being a credit card number. The value
cannot be sanitized. Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'creditCard');
</code></pre></li>
<li><p><code>dateTime</code>: Validate the value as representing a date and/or time. Sanitize
the value to a specified format, default <code>'Y-m-d H:i:s'</code>. Usage (note that
this is to sanitize, not validate):</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::FIX, 'dateTime', $format);
</code></pre></li>
<li><p><code>email</code>: Validate the value as being a properly-formed email address. The
value cannot be sanitized. Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'email');
</code></pre></li>
<li><p><code>equalToField</code>: Validate the value as loosely equal to the value of another
field in the data object. Sanitize to the value of that other field.
Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'equalToField', 'other_field_name');
</code></pre></li>
<li><p><code>equalToValue</code>: Validate the value as loosely equal to a specified value.
Sanitize to the specified value. Usage:</p></li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::IS, 'equalToValue', $other_value);</pre>
</div>

<ul>
<li><p><code>float</code>: Validate the value as representing a float. Sanitize the value to
transform it into a float; for weird strings, this may not be what you
expect. Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'float');
</code></pre></li>
<li><p><code>inKeys</code>: Validate that the value is loosely equal to a key in a given
array. The value cannot be sanitized. Usage:</p></li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::IS, 'inKeys', $array);</pre>
</div>

<ul>
<li><code>inValues</code>: Validate that the value is strictly equal to at least one value
in a given array. The value cannot be sanitized. Usage:</li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::IS, 'inValues', $array);
&nbsp;</pre>
</div>

<ul>
<li><p><code>int</code>: Validate the value as representing an integer Sanitize the value to
transform it into an integer; for weird strings, this may not be what you
expect. Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'int');
</code></pre></li>
<li><p><code>ipv4</code>: Validate the value as an IPv4 address. The value cannot be
sanitized. Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'ipv4');
</code></pre></li>
<li><p><code>locale</code>: Validate the given value against a list of locale strings. If it's 
not found returns false. The value cannot be sanitized. Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'locale');
</code></pre></li>
<li><p><code>max</code>: Validate the value as being less than or equal to a maximum. Sanitize
so that values higher than the maximum are forced down to the maximum.
Usage:</p></li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::IS, 'max', $max);</pre>
</div>

<ul>
<li><code>min</code>: Validate the value as being greater than or equal to a minimum.
Sanitize so that values lower than the minimum are forced up to the
minimum. Usage:</li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::IS, 'min', $min);</pre>
</div>

<ul>
<li><code>regex</code>: Validate the value using <code>preg_match()</code>. Sanitize the value using
<code>preg_replace()</code>.</li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::IS, 'regex', $expr);
&nbsp;</pre>
</div>

<ul>
<li><p><code>strictEqualToField</code>: Validate the value as strictly equal to the value of
another field in the data object. Sanitize to the value of that other field.
Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'strictEqualToField', 'other_field_name');
</code></pre></li>
<li><p><code>strictEqualToValue</code>: Validate the value as strictly equal to a specified
value. Sanitize to the specified value. Usage:</p></li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::IS, 'strictEqualToValue', $other_value);</pre>
</div>

<ul>
<li><code>string</code>: Validate the value can be represented by a string. Sanitize the
value by casting to a string and optionally using <code>str_replace().</code> Usage
(note that this is to sanitize, not validate):</li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::FIX, 'string', $find, $replace);
&nbsp;</pre>
</div>

<ul>
<li><code>strlen</code>: Validate the value has a specified length. Sanitize the value
to cut off longer values at the right, and <code>str_pad()</code> shorter ones. Usage:</li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::IS, 'strlen', $len);</pre>
</div>

<ul>
<li><code>strlenBetween</code>: Validate the value length as being within or equal to a
minimum and maximum value. Sanitize the value to cut off values longer than
the maximum, longer values at the right, and <code>str_pad()</code> shorter ones.
Usage:</li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::IS, 'strlenBetween', $min, $max);
&nbsp;</pre>
</div>

<ul>
<li><code>strlenMax</code>: Validate the value length as being no longer than a maximum.
Sanitize the value to cut off values longer than the maximum. Usage:</li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::IS, 'strlenMax', $max);
&nbsp;</pre>
</div>

<ul>
<li><code>strlenMin</code>: Validate the value length as being no shorter than a minimum.
Sanitize the value to <code>str_pad()</code> values shorter than the minimum. Usage:</li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::IS, 'strlenMin', $min);
&nbsp;</pre>
</div>

<ul>
<li><code>trim</code>: Validate the value is <code>trim()</code>med. Sanitize the value to <code>trim()</code> it.
Optionally specify characters to trim. Usage:</li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::IS, 'trim', $chars);
&nbsp;</pre>
</div>

<ul>
<li><p><code>upload</code>: Validate the value represents a PHP upload information array, and
that the file is an uploaded file. The value cannot be sanitized. Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'upload');
</code></pre></li>
<li><p><code>url</code>: Validate the value is a well-formed URL. The value cannot be
sanitized. Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'url');
</code></pre></li>
<li><p><code>word</code>: Validate the value as being composed only of word characters.
Sanitize the value to remove non-word characters. Usage:</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'word');
</code></pre></li>
<li><p><code>isbn</code>: Validate the value is a correct ISBN (International Standard Book Number). Usage:</p></li>
</ul>

<div class="code code">
<pre class="code">    $filter-&gt;addSoftRule('field', $filter::IS, 'isbn');</pre>
</div>

<ul>
<li><p><code>any</code>: Validate the value passes at-least one of the rules. These rules
are the ones added in rule locator.</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'any', [
        ['alnum'],
        ['email'],
        // more rules
    ]
);
</code></pre></li>
<li><p><code>all</code>: Validate the value against a set of rules. These rules
are should be added in rule locator. You will not get seprate error 
messages for which all rules it failed.</p>

<pre><code>$filter-&gt;addSoftRule('field', $filter::IS, 'all', [
        // rules
    ]
);
</code></pre></li>
</ul>

<h2 id="custom-messages">12.5 Custom Messages</h2>

<p>By default when a rule fails, the messages you will be getting are from the 
<code>intl/en_US.php</code>. But you can also provide a single custom message for 
all the failures.</p>

<div class="code php">
<pre class="php"><span class="re0">$filter</span><span class="sy0">-&gt;</span><span class="me1">useFieldMessage</span><span class="br0">&#40;</span><span class="st_h">'field'</span><span class="sy0">,</span> <span class="st_h">'Custom Message'</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>Example:</p>

<div class="code php">
<pre class="php"><span class="re0">$filter</span><span class="sy0">-&gt;</span><span class="me1">addSoftRule</span><span class="br0">&#40;</span><span class="st_h">'username'</span><span class="sy0">,</span> <span class="re0">$filter</span><span class="sy0">::</span><span class="me2">IS</span><span class="sy0">,</span> <span class="st_h">'alnum'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$filter</span><span class="sy0">-&gt;</span><span class="me1">addSoftRule</span><span class="br0">&#40;</span><span class="st_h">'username'</span><span class="sy0">,</span> <span class="re0">$filter</span><span class="sy0">::</span><span class="me2">IS</span><span class="sy0">,</span> <span class="st_h">'strlenBetween'</span><span class="sy0">,</span> <span class="nu0">6</span><span class="sy0">,</span> <span class="nu0">12</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$data</span> <span class="sy0">=</span> <span class="br0">&#40;</span>object<span class="br0">&#41;</span> <span class="br0">&#91;</span>
    <span class="st_h">'username'</span> <span class="sy0">=&gt;</span> <span class="st_h">' sds'</span><span class="sy0">,</span>
<span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp;
<span class="re0">$filter</span><span class="sy0">-&gt;</span><span class="me1">useFieldMessage</span><span class="br0">&#40;</span><span class="st_h">'username'</span><span class="sy0">,</span> <span class="st_h">'User name already exists'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co1">// filter the object and see if there were failures</span>
<span class="re0">$success</span> <span class="sy0">=</span> <span class="re0">$filter</span><span class="sy0">-&gt;</span><span class="me1">values</span><span class="br0">&#40;</span><span class="re0">$data</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span> <span class="re0">$success</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="re0">$messages</span> <span class="sy0">=</span> <span class="re0">$filter</span><span class="sy0">-&gt;</span><span class="me1">getMessages</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">var_export</span><span class="br0">&#40;</span><span class="re0">$messages</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>As you have used <code>useFieldMessage</code> you will see</p>

<div class="code php">
<pre class="php"><span class="kw3">array</span> <span class="br0">&#40;</span>
  <span class="st_h">'username'</span> <span class="sy0">=&gt;</span> 
  <span class="kw3">array</span> <span class="br0">&#40;</span>
    <span class="nu0">0</span> <span class="sy0">=&gt;</span> <span class="st_h">'User name already exists'</span><span class="sy0">,</span>
  <span class="br0">&#41;</span><span class="sy0">,</span>
<span class="br0">&#41;</span></pre>
</div>

<p>instead of</p>

<div class="code php">
<pre class="php"><span class="kw3">array</span> <span class="br0">&#40;</span>
  <span class="st_h">'username'</span> <span class="sy0">=&gt;</span> 
  <span class="kw3">array</span> <span class="br0">&#40;</span>
    <span class="nu0">0</span> <span class="sy0">=&gt;</span> <span class="st_h">'Please use only alphanumeric characters.'</span><span class="sy0">,</span>
    <span class="nu0">1</span> <span class="sy0">=&gt;</span> <span class="st_h">'Please use between 6 and 12 characters.'</span><span class="sy0">,</span>
  <span class="br0">&#41;</span><span class="sy0">,</span>
<span class="br0">&#41;</span></pre>
</div>

<h2 id="creating-and-using-custom-rules">12.6 Creating and Using Custom Rules</h2>

<p>There are three steps to creating and using new rules:</p>

<ol>
<li><p>Write a rule class</p></li>
<li><p>Set that class as a service in the <code>RuleLocator</code></p></li>
<li><p>Use the new rule in our filter chain</p></li>
</ol>

<h2 id="writing-a-rule-class">12.7 Writing a Rule Class</h2>

<p>Writing a rule class is straightforward:</p>

<ul>
<li><p>Extend <code>Aura\Filter\AbstractRule</code> with two methods: <code>validate()</code> and
<code>sanitize()</code>.</p></li>
<li><p>Add params as needed to each method.</p></li>
<li><p>Each method should return a boolean: true on success, or false on failure.</p></li>
<li><p>Use <code>getValue()</code> to get the value being validated, and <code>setValue()</code> to change
the value being sanitized.</p></li>
<li><p>Add a property <code>$message</code> to indicate a string that should be translated
as a message when validation or sanitizing fails.</p></li>
</ul>

<p>Here is an example of a hexadecimal rule:</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="kw2">namespace</span> Example\Package\Filter\Rule<span class="sy0">;</span>
&nbsp;
<span class="kw2">use</span> Aura\Filter\AbstractRule<span class="sy0">;</span>
&nbsp;
<span class="kw2">class</span> Hex <span class="kw2">extends</span> AbstractRule
<span class="br0">&#123;</span>
    <span class="kw2">protected</span> <span class="re0">$message</span> <span class="sy0">=</span> <span class="st_h">'FILTER_HEX'</span><span class="sy0">;</span>
&nbsp;
    <span class="kw2">public</span> <span class="kw2">function</span> validate<span class="br0">&#40;</span><span class="re0">$max</span> <span class="sy0">=</span> <span class="kw4">null</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="co1">// must be scalar</span>
        <span class="re0">$value</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getValue</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span> <span class="kw3">is_scalar</span><span class="br0">&#40;</span><span class="re0">$value</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="co1">// must be hex</span>
        <span class="re0">$hex</span> <span class="sy0">=</span> <span class="kw3">ctype_xdigit</span><span class="br0">&#40;</span><span class="re0">$value</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span> <span class="re0">$hex</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="co1">// must be no longer than $max chars</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$max</span> <span class="sy0">&amp;&amp;</span> <span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$value</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="re0">$max</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="co1">// done!</span>
        <span class="kw1">return</span> <span class="kw4">true</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw2">public</span> <span class="kw2">function</span> sanitize<span class="br0">&#40;</span><span class="re0">$max</span> <span class="sy0">=</span> <span class="kw4">null</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="co1">// must be scalar</span>
        <span class="re0">$value</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getValue</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span> <span class="kw3">is_scalar</span><span class="br0">&#40;</span><span class="re0">$value</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="co1">// sanitizing failed</span>
            <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="co1">// strip out non-hex characters</span>
        <span class="re0">$value</span> <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span><span class="st_h">'/[^0-9a-f]/i'</span><span class="sy0">,</span> <span class="st_h">''</span><span class="sy0">,</span> <span class="re0">$value</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$value</span> <span class="sy0">===</span> <span class="st_h">''</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="co1">// failed to sanitize to a hex value</span>
            <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="co1">// now check length and chop if needed</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$max</span> <span class="sy0">&amp;&amp;</span> <span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$value</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="re0">$max</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">$value</span> <span class="sy0">=</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$value</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="re0">$max</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="co1">// retain the sanitized value, and done!</span>
        <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">setValue</span><span class="br0">&#40;</span><span class="re0">$value</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">return</span> <span class="kw4">true</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
</div>

<h2 id="set-the-class-as-a-service">12.8 Set The Class As A Service</h2>

<p>Now we set the rule class into the <code>RuleLocator</code>.</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="re0">$locator</span> <span class="sy0">=</span> <span class="re0">$filter</span><span class="sy0">-&gt;</span><span class="me1">getRuleLocator</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$locator</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'hex'</span><span class="sy0">,</span> <span class="kw2">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">return</span> <span class="kw2">new</span> Example\Package\Filter\Rule\Hex<span class="sy0">;</span>
<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<h2 id="apply-the-new-rule">12.9 Apply The New Rule</h2>

<p>Finally, we can use the rule in our filter:</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="co1">// the 'color' field must be a hex value of no more than 6 digits</span>
<span class="re0">$filter</span><span class="sy0">-&gt;</span><span class="me1">addHardRule</span><span class="br0">&#40;</span><span class="st_h">'color'</span><span class="sy0">,</span> <span class="re0">$filter</span><span class="sy0">::</span><span class="me2">IS</span><span class="sy0">,</span> <span class="st_h">'hex'</span><span class="sy0">,</span> <span class="nu0">6</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>That is all!</p>

    </div>

    <div class="span3">
        <div class="item local_toc">
            <h3>Table of contents</h3>

            <ul class="unstyled">
                                                <li class="level-1">
                        <span></span>
                        <a class="internal" href="./chapter-12.html#validation-and-sanitization">Validation and Sanitization</a>
                    </li>
                                    <li class="level-2">
                        <span>12.1</span>
                        <a class="internal" href="./chapter-12.html#applying-rules-to-data-objects">Applying Rules to Data Objects</a>
                    </li>
                                    <li class="level-2">
                        <span>12.2</span>
                        <a class="internal" href="./chapter-12.html#validating-and-sanitizing">Validating and Sanitizing</a>
                    </li>
                                    <li class="level-2">
                        <span>12.3</span>
                        <a class="internal" href="./chapter-12.html#blank-values">Blank Values</a>
                    </li>
                                    <li class="level-2">
                        <span>12.4</span>
                        <a class="internal" href="./chapter-12.html#available-rules">Available Rules</a>
                    </li>
                                    <li class="level-2">
                        <span>12.5</span>
                        <a class="internal" href="./chapter-12.html#custom-messages">Custom Messages</a>
                    </li>
                                    <li class="level-2">
                        <span>12.6</span>
                        <a class="internal" href="./chapter-12.html#creating-and-using-custom-rules">Creating and Using Custom Rules</a>
                    </li>
                                    <li class="level-2">
                        <span>12.7</span>
                        <a class="internal" href="./chapter-12.html#writing-a-rule-class">Writing a Rule Class</a>
                    </li>
                                    <li class="level-2">
                        <span>12.8</span>
                        <a class="internal" href="./chapter-12.html#set-the-class-as-a-service">Set The Class As A Service</a>
                    </li>
                                    <li class="level-2">
                        <span>12.9</span>
                        <a class="internal" href="./chapter-12.html#apply-the-new-rule">Apply The New Rule</a>
                    </li>
                                        </ul>
        </div>
    </div>
</div>
</div>
</body>
</html>