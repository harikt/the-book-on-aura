<!doctype html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="author" content="Hari KT, Paul M Jones" />
    <meta name="date" content="07/07/2013"/>
    <meta name="generator" content="easybook 5.0-DEV"/>

    <title>Dependency Injection | The complete reference for Aura</title>

    <link rel="stylesheet" href="./css/easybook.css" />

</head>

<body class="item chapter">
<div class="container">
<div class="menu">
    <div class="row">
        <h1 class="span9"><a href="./index.html">The complete reference for Aura</a></h1>
        <p class="span3">
                        <a href="./chapter-7.html"><span>&larr;</span> Previous</a>
            
                        <a href="./chapter-10.html">Next <span>&rarr;</span></a>
                    </p>
    </div>
</div>

<div class="row">
    <div class="span9">
        <h1 id="dependency-injection"><span>Chapter 9</span> Dependency Injection</h1>
        <p>The Aura DI package provides a dependency injection container system with the
following features:</p>

<ul>
<li><p>native support for constructor- and setter-based injection</p></li>
<li><p>lazy-loading of services</p></li>
<li><p>inheritable configuration of setters and constructor params</p></li>
</ul>

<p>When combined with factory classes, you can completely separate object
configuration, object construction, and object usage, allowing for great
flexibility and increased testability.</p>

<p>Fully describing the nature and benefits of dependency injection, while
desirable, is beyond the scope of this document. For more information about
"inversion of control" and "dependency injection" please consult
<a href="http://martinfowler.com/articles/injection.html">http://martinfowler.com/articles/injection.html</a> by Martin Fowler.</p>

<h2 id="instantiating-the-container">9.1 Instantiating the Container</h2>

<p>The Aura DI package comes with a instance script that returns a new DI
instance:</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="re0">$di</span> <span class="sy0">=</span> <span class="kw1">require</span> <span class="st_h">'/path/to/Aura.Di/scripts/instance.php'</span><span class="sy0">;</span></pre>
</div>

<p>Alternatively, you can add the Aura DI <code>'src/'</code> directory to your autoloader,
and then instantiate it yourself:</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="kw2">use</span> Aura\Di\Container<span class="sy0">;</span>
<span class="kw2">use</span> Aura\Di\Forge<span class="sy0">;</span>
<span class="kw2">use</span> Aura\Di\Config<span class="sy0">;</span>
&nbsp;
<span class="re0">$di</span> <span class="sy0">=</span> <span class="kw2">new</span> Container<span class="br0">&#40;</span><span class="kw2">new</span> Forge<span class="br0">&#40;</span><span class="kw2">new</span> Config<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>The <code>Container</code> is the DI container proper.  The support objects are:</p>

<ul>
<li><p>a <code>Config</code> object for collection, retrieval, and merging of setters and constructor params</p></li>
<li><p>a <code>Forge</code> for object creation using the unified <code>Config</code> values</p></li>
</ul>

<p>We will not need to use the support objects directly; we will get access to
their behaviors through <code>Container</code> methods.</p>

<h2 id="setting-services">9.2 Setting Services</h2>

<p>For the following examples, we will set a service that should return a
database connection. The hypothetical database connection class is defined as
follows:</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="kw2">namespace</span> Example\Package<span class="sy0">;</span>
&nbsp;
<span class="kw2">class</span> Database
<span class="br0">&#123;</span>
    <span class="kw2">public</span> <span class="kw2">function</span> __construct<span class="br0">&#40;</span><span class="re0">$hostname</span><span class="sy0">,</span> <span class="re0">$username</span><span class="sy0">,</span> <span class="re0">$password</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="co1">// ... make the database connection</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>We will proceed from naive service creation to a more sophisticated idiom in
four steps. Each of the variations is a valid use of the DI container with its
own strengths and weaknesses.</p>

<h2 id="variation-1-eager-loading">9.3 Variation 1: Eager Loading</h2>

<p>In this variation, we create a service by instantiating an object with the
<code>new</code> operator.</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'database'</span><span class="sy0">,</span> <span class="kw2">new</span> \Example\Package\Database<span class="br0">&#40;</span>
    <span class="st_h">'localhost'</span><span class="sy0">,</span> <span class="st_h">'user'</span><span class="sy0">,</span> <span class="st_h">'passwd'</span>
<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>This causes the database object to be created at the time we <em>set</em> the service
into the container. That means it is always created, even if we never retrieve
it from the container.</p>

<h2 id="variation-2-lazy-loading">9.4 Variation 2: Lazy Loading</h2>

<p>In this variation, we create a service by wrapping it in a closure, still
using the <code>new</code> operator.</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'database'</span><span class="sy0">,</span> <span class="kw2">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">return</span> <span class="kw2">new</span> \Example\Package\Database<span class="br0">&#40;</span><span class="st_h">'localhost'</span><span class="sy0">,</span> <span class="st_h">'user'</span><span class="sy0">,</span> <span class="st_h">'passwd'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>This causes the database object to be created at the time we <em>get</em> the service
from the container, using <code>$di-&gt;get('database')</code>. Wrapping the object
instantiation inside a closure allows for lazy-loading of the database object;
if we never make a call to <code>$di-&gt;get('database')</code>, the object will never be
created.</p>

<h2 id="variation-3-constructor-params">9.5 Variation 3: Constructor Params</h2>

<p>In this variation, we will move away from using the <code>new</code> operator, and use
the <code>$di-&gt;newInstance()</code> method instead. We still wrap the instantiation in a
closure for lazy-loading.</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'database'</span><span class="sy0">,</span> <span class="kw2">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw2">use</span> <span class="br0">&#40;</span><span class="re0">$di</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">return</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">newInstance</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\Database'</span><span class="sy0">,</span> <span class="br0">&#91;</span>
        <span class="st_h">'hostname'</span> <span class="sy0">=&gt;</span> <span class="st_h">'localhost'</span><span class="sy0">,</span>
        <span class="st_h">'username'</span> <span class="sy0">=&gt;</span> <span class="st_h">'user'</span><span class="sy0">,</span>
        <span class="st_h">'password'</span> <span class="sy0">=&gt;</span> <span class="st_h">'passwd'</span><span class="sy0">,</span>
    <span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>The <code>newInstance()</code> method uses the <code>Forge</code> object to reflect on the
constructor method of the class to be instantiated. We can then pass
constructor parameters based on their names as an array of key-value pairs.
The order of the pairs does not matter; missing parameters will use the
defaults as defined by the class constructor.</p>

<h2 id="variation-4-class-constructor-params">9.6 Variation 4: Class Constructor Params</h2>

<p>In this variation, we define a configuration for the <code>Database</code> class
separately from the lazy-load instantiation of the <code>Database</code> object.</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">params</span><span class="br0">&#91;</span><span class="st_h">'Example\Package\Database'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#91;</span>
    <span class="st_h">'hostname'</span> <span class="sy0">=&gt;</span> <span class="st_h">'localhost'</span><span class="sy0">,</span>
    <span class="st_h">'username'</span> <span class="sy0">=&gt;</span> <span class="st_h">'user'</span><span class="sy0">,</span>
    <span class="st_h">'password'</span> <span class="sy0">=&gt;</span> <span class="st_h">'passwd'</span><span class="sy0">,</span>
<span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp;
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'database'</span><span class="sy0">,</span> <span class="kw2">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw2">use</span> <span class="br0">&#40;</span><span class="re0">$di</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">return</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">newInstance</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\Database'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>As part of the object-creation process, the <code>Forge</code> examines the <code>$di-&gt;params</code>
values for the class being instantiated. Those values are merged with the
class constructor defaults at instantiation time, and passed to the
constructor (again, the order does not matter, only that the param key names
match the constructor param names).</p>

<p>At this point, we have successfully separated object configuration from object
instantiation, and allow for lazy-loading of service objects from the
container.</p>

<h2 id="variation-5-call-the-lazynew-method">9.7 Variation 5: Call The lazyNew() Method</h2>

<p>In this variation, we call the <code>lazyNew()</code> method, which encapsulates the
"use a closure to return a new instance" idiom.</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">params</span><span class="br0">&#91;</span><span class="st_h">'Example\Package\Database'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#91;</span>
    <span class="st_h">'hostname'</span> <span class="sy0">=&gt;</span> <span class="st_h">'localhost'</span><span class="sy0">,</span>
    <span class="st_h">'username'</span> <span class="sy0">=&gt;</span> <span class="st_h">'user'</span><span class="sy0">,</span>
    <span class="st_h">'password'</span> <span class="sy0">=&gt;</span> <span class="st_h">'passwd'</span><span class="sy0">,</span>
<span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp;
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'database'</span><span class="sy0">,</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyNew</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\Database'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<h2 id="variation-5a-override-class-constructor-params">9.8 Variation 5a: Override Class Constructor Params</h2>

<p>In this variation, we override the <code>$di-&gt;params</code> values that will be used at
instantiation time.</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">params</span><span class="br0">&#91;</span><span class="st_h">'Example\Package\Database'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#91;</span>
    <span class="st_h">'hostname'</span> <span class="sy0">=&gt;</span> <span class="st_h">'localhost'</span><span class="sy0">,</span>
    <span class="st_h">'username'</span> <span class="sy0">=&gt;</span> <span class="st_h">'user'</span><span class="sy0">,</span>
    <span class="st_h">'password'</span> <span class="sy0">=&gt;</span> <span class="st_h">'passwd'</span><span class="sy0">,</span>
<span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp;
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'database'</span><span class="sy0">,</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyNew</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\Database'</span><span class="sy0">,</span> <span class="br0">&#91;</span>
    <span class="st_h">'hostname'</span> <span class="sy0">=&gt;</span> <span class="st_h">'example.com'</span><span class="sy0">,</span>
<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>The instantiation-time values take precedence over the configuration values,
which themselves take precedence over the constructor defaults.</p>

<h2 id="getting-services">9.9 Getting Services</h2>

<p>To get a service object from the container, call <code>$di-&gt;get()</code>.</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="re0">$db</span> <span class="sy0">=</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">get</span><span class="br0">&#40;</span><span class="st_h">'database'</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>This will retrieve the service object from the container; if it was set using
a closure, the closure will be invoked to create the object at that time. Once
the object is created, it is retained in the container for future use; getting
the same service multiple times will return the exact same object instance.</p>

<h2 id="constructor-params-inheritance">9.10 Constructor Params Inheritance</h2>

<p>For the following examples, we will add an <code>AbstractModel</code> class and two
concrete classes called <code>BlogModel</code> and <code>WikiModel</code>. The idea is that all
<code>AbstractModel</code> classes need a <code>Database</code> connection to interact with one or
more tables in the database.</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="kw2">namespace</span> Example\Package<span class="sy0">;</span>
&nbsp;
<span class="kw2">abstract</span> <span class="kw2">class</span> AbstractModel
<span class="br0">&#123;</span>
    <span class="kw2">protected</span> <span class="re0">$db</span><span class="sy0">;</span>
&nbsp;
    <span class="kw2">public</span> <span class="kw2">function</span> __construct<span class="br0">&#40;</span>Database <span class="re0">$db</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">db</span> <span class="sy0">=</span> <span class="re0">$db</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">class</span> BlogModel <span class="kw2">extends</span> AbstractModel
<span class="br0">&#123;</span>
    <span class="co1">// ...</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">class</span> WikiModel <span class="kw2">extends</span> AbstractModel
<span class="br0">&#123;</span>
    <span class="co1">// ...</span>
<span class="br0">&#125;</span></pre>
</div>

<p>We will create services for the <code>BlogModel</code> and <code>WikiModel</code>, and inject the
database service into them as part of the service definition. Using config
inheritance provided by the DI container, we can define the database service
injection through class configuration.</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="co1">// default params for the Database class</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">params</span><span class="br0">&#91;</span><span class="st_h">'Example\Package\Database'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#91;</span>
    <span class="st_h">'hostname'</span> <span class="sy0">=&gt;</span> <span class="st_h">'localhost'</span><span class="sy0">,</span>
    <span class="st_h">'username'</span> <span class="sy0">=&gt;</span> <span class="st_h">'user'</span><span class="sy0">,</span>
    <span class="st_h">'password'</span> <span class="sy0">=&gt;</span> <span class="st_h">'passwd'</span><span class="sy0">,</span>
<span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// default params for the AbstractModel class</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">params</span><span class="br0">&#91;</span><span class="st_h">'Example\Package\AbstractModel'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#91;</span>
    <span class="st_h">'db'</span> <span class="sy0">=&gt;</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyGet</span><span class="br0">&#40;</span><span class="st_h">'database'</span><span class="br0">&#41;</span><span class="sy0">,</span>
<span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// define the database service</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'database'</span><span class="sy0">,</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyNew</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\Database'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// define the blog_model service</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'blog_model'</span><span class="sy0">,</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyNew</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\BlogModel'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// define the wiki_model service</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'wiki_model'</span><span class="sy0">,</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyNew</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\WikiModel'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>We do not need to set the value of the <code>'db'</code> param for the <code>BlogModel</code> and
<code>WikiModel</code> directly. Instead, the params for the <code>AbstractModel</code> class are
automatically inherited by the child <code>BlogModel</code> and <code>WikiModel</code> classes, so
the <code>'db'</code> constructor param for all <code>Model</code> classes automatically gets the
<code>'database'</code> service. (We can override that at instantiation time if we like.)</p>

<p>Note the use of the <code>lazyGet()</code> method. This is a special method intended for
use with params and setters. If we used <code>$di-&gt;get()</code>, the container would
instantiate the service at that time. However, using <code>$di-&gt;lazyGet()</code> allows
the service to be instantiated only when the object being configured is
instantiated. Think of it as a lazy-loading wrapper around the service (which
itself may be lazy-loaded).</p>

<p>We do not need to write our classes in any special way to get the benefit of
this configuration system. Any class with constructor params will be
recognized by the configuration system, so long as we instantiate it via
<code>$di-&gt;newInstance()</code>or <code>$di-&gt;lazyNew()</code>.</p>

<h2 id="factories-and-dependency-fulfillment">9.11 Factories and Dependency Fulfillment</h2>

<p>Creating a service for each of the model objects in our application can become
tiresome. We may need to create other models, and we don't want to have to
create a separate service for each one. In addition, we may need to create
model objects from within another object. Finally, we don't want to create
model objects until we actually need them. This is where we can make use of
factories.</p>

<p>Below, we will define three new classes: a factory to create model objects for
us, an abstract <code>PageController</code> class that uses the model factory, and a
<code>BlogController</code> class that needs an instance of a blog model. We will
populate the <code>ModelFactory</code> with a map of model names to factory objects that
will create the mapped objects.</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="kw2">namespace</span> Example\Package<span class="sy0">;</span>
&nbsp;
<span class="kw2">class</span> ModelFactory
<span class="br0">&#123;</span>
    <span class="co1">// a map of model names to factory closures</span>
    <span class="kw2">protected</span> <span class="re0">$map</span> <span class="sy0">=</span> <span class="br0">&#91;</span><span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw2">public</span> <span class="kw2">function</span> __construct<span class="br0">&#40;</span><span class="re0">$map</span> <span class="sy0">=</span> <span class="br0">&#91;</span><span class="br0">&#93;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">map</span> <span class="sy0">=</span> <span class="re0">$map</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw2">public</span> <span class="kw2">function</span> newInstance<span class="br0">&#40;</span><span class="re0">$model_name</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$factory</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">map</span><span class="br0">&#91;</span><span class="re0">$model_name</span><span class="br0">&#93;</span><span class="sy0">;</span>
        <span class="re0">$model</span> <span class="sy0">=</span> <span class="re0">$factory</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">return</span> <span class="re0">$model</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">abstract</span> <span class="kw2">class</span> PageController
<span class="br0">&#123;</span>
    <span class="kw2">protected</span> <span class="re0">$model_factory</span><span class="sy0">;</span>
&nbsp;
    <span class="kw2">public</span> <span class="kw2">function</span> __construct<span class="br0">&#40;</span>ModelFactory <span class="re0">$model_factory</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">model_factory</span> <span class="sy0">=</span> <span class="re0">$model_factory</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">class</span> BlogController <span class="kw2">extends</span> PageController
<span class="br0">&#123;</span>
    <span class="kw2">public</span> <span class="kw2">function</span> <span class="kw3">exec</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$blog_model</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">model_factory</span><span class="br0">&#40;</span><span class="st_h">'blog'</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="co1">// ... get data from the blog model and return it ...</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>Now we can set up the DI container as follows:</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="co1">// default params for database connections</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">params</span><span class="br0">&#91;</span><span class="st_h">'Example\Package\Database'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#91;</span>
    <span class="st_h">'hostname'</span> <span class="sy0">=&gt;</span> <span class="st_h">'localhost'</span><span class="sy0">,</span>
    <span class="st_h">'username'</span> <span class="sy0">=&gt;</span> <span class="st_h">'user'</span><span class="sy0">,</span>
    <span class="st_h">'password'</span> <span class="sy0">=&gt;</span> <span class="st_h">'passwd'</span><span class="sy0">,</span>
<span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// default params for the AbstractModel class</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">params</span><span class="br0">&#91;</span><span class="st_h">'Example\Package\AbstractModel'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#91;</span>
    <span class="st_h">'db'</span> <span class="sy0">=&gt;</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyGet</span><span class="br0">&#40;</span><span class="st_h">'database'</span><span class="br0">&#41;</span><span class="sy0">,</span>
<span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// default params for the model factory</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">params</span><span class="br0">&#91;</span><span class="st_h">'Example\Package\ModelFactory'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#91;</span>
    <span class="co1">// a map of model names to model factories</span>
    <span class="st_h">'map'</span> <span class="sy0">=&gt;</span> <span class="br0">&#91;</span>
        <span class="st_h">'blog'</span> <span class="sy0">=&gt;</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">newFactory</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\BlogModel'</span><span class="br0">&#41;</span><span class="sy0">,</span>
        <span class="st_h">'wiki'</span> <span class="sy0">=&gt;</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">newFactory</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\WikiModel'</span><span class="br0">&#41;</span><span class="sy0">,</span>
    <span class="br0">&#93;</span><span class="sy0">,</span>
<span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// default params for page controllers</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">params</span><span class="br0">&#91;</span><span class="st_h">'Example\Package\PageController'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#91;</span>
    <span class="st_h">'model_factory'</span> <span class="sy0">=&gt;</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyGet</span><span class="br0">&#40;</span><span class="st_h">'model_factory'</span><span class="br0">&#41;</span><span class="sy0">,</span>
<span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// the database service; note that we can use lazyNew() and the</span>
<span class="co1">// forge will do all the setup for us</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'database'</span><span class="sy0">,</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyNew</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\Database'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// the model factory service</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'model_factory'</span><span class="sy0">,</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyNew</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\ModelFactory'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>When we create an instance of the <code>BlogController</code> and run it ...</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="re0">$blog_controller</span> <span class="sy0">=</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">newInstance</span><span class="br0">&#40;</span><span class="st_h">'Aura\Example\BlogController'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">echo</span> <span class="re0">$blog_controller</span><span class="sy0">-&gt;</span><span class="kw3">exec</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>... a series of events occurs to fulfill all the dependencies in two steps.
The first step is the instantiation of the <code>BlogController</code>:</p>

<ul>
<li><p>The <code>BlogController</code> instance inherits its params from <code>PageController</code></p></li>
<li><p>The <code>PageController</code> params get the <code>'model_factory'</code> service</p></li>
<li><p>The <code>ModelFactory</code> params get the <code>Database</code> object, creating the
database connection at that time</p></li>
</ul>

<p>The second step is the invocation of <code>ModelFactory::newInstance()</code> within
<code>BlogController::exec()</code>:</p>

<ul>
<li><p><code>BlogController::exec()</code> invokes <code>ModelFactory::newInstance()</code></p></li>
<li><p><code>ModelFactory::newInstance()</code> creates a new class and passes in the
<code>Database</code> object</p></li>
</ul>

<p>At the end of all this, the <code>BlogController::exec()</code> method has been able to
retrieve a fully-configured <code>BlogModel</code> object without having to specify any
configuration locally.</p>

<h2 id="setter-injection">9.12 Setter Injection</h2>

<p>Until this point, we have been working via constructor injection. However, we
can work via setter injection as well.</p>

<p>Given the following example class ...</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="kw2">namespace</span> Example\Package<span class="sy0">;</span>
&nbsp;
<span class="kw2">class</span> Foo <span class="br0">&#123;</span>
&nbsp;
    <span class="kw2">protected</span> <span class="re0">$db</span><span class="sy0">;</span>
&nbsp;
    <span class="kw2">public</span> <span class="kw2">function</span> setDb<span class="br0">&#40;</span>Database <span class="re0">$db</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">db</span> <span class="sy0">=</span> <span class="re0">$db</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>... we can define values that should be injected via setter methods:</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="co1">// after construction, the Forge will call Foo::setDb()</span>
<span class="co1">// and inject the 'database' service object</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">setter</span><span class="br0">&#91;</span><span class="st_h">'Example\Package\Foo'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'setDb'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyGet</span><span class="br0">&#40;</span><span class="st_h">'database'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// create a foo_service; on get('foo_service'), the Forge will create the</span>
<span class="co1">// Foo object, then call setDb() on it per the setter specification above.</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'foo_service'</span><span class="sy0">,</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyNew</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\Foo'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;</pre>
</div>

<p>Note that we use <code>lazyGet()</code> for the injection. As with constructor params, we
could tell the class to use a new <code>Database</code> object instead of the shared one
in the <code>Container</code>:</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="co1">// after construction, call Foo::setDb() and inject a service object.</span>
<span class="co1">// we override the default 'hostname' param for the instantiation.</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">setter</span><span class="br0">&#91;</span><span class="st_h">'Example\Package\Foo'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'setDb'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyNew</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\Database'</span><span class="sy0">,</span> <span class="br0">&#91;</span>
    <span class="st_h">'hostname'</span> <span class="sy0">=&gt;</span> <span class="st_h">'example.com'</span><span class="sy0">,</span>
<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// create a foo_service; on get('foo_service'), the Forge will create the</span>
<span class="co1">// Foo object, then call setDb() on it per the setter specification above.</span>
<span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">set</span><span class="br0">&#40;</span><span class="st_h">'foo_service'</span><span class="sy0">,</span> <span class="re0">$di</span><span class="sy0">-&gt;</span><span class="me1">lazyNew</span><span class="br0">&#40;</span><span class="st_h">'Example\Package\Foo'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;</pre>
</div>

<p>Setter configurations are inherited. If you have a class that extends
<code>Example\Package\Foo</code> like so ...</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span>
<span class="kw2">namespace</span> Example\Package<span class="sy0">;</span>
<span class="kw2">class</span> Bar <span class="kw2">extends</span> Foo
<span class="br0">&#123;</span>
<span class="co1">// ...</span>
<span class="br0">&#125;</span></pre>
</div>

<p>... you do not need to add a new setter value for it; the <code>Forge</code> reads all
parent setters and applies them. (If you do add a setter value for that class,
it will override the parent setter.)</p>

<h2 id="conclusion">9.13 Conclusion</h2>

<p>If we construct our dependencies properly with params, setters, services, and
factories, we will only need to get one object directly from DI container. All
object creation will then happen through the DI container via factory objects
and/or the <code>Forge</code> object. We will never need to use the DI container itself
in any of the created objects.</p>

    </div>

    <div class="span3">
        <div class="item local_toc">
            <h3>Table of contents</h3>

            <ul class="unstyled">
                                                <li class="level-1">
                        <span></span>
                        <a class="internal" href="./chapter-9.html#dependency-injection">Dependency Injection</a>
                    </li>
                                    <li class="level-2">
                        <span>9.1</span>
                        <a class="internal" href="./chapter-9.html#instantiating-the-container">Instantiating the Container</a>
                    </li>
                                    <li class="level-2">
                        <span>9.2</span>
                        <a class="internal" href="./chapter-9.html#setting-services">Setting Services</a>
                    </li>
                                    <li class="level-2">
                        <span>9.3</span>
                        <a class="internal" href="./chapter-9.html#variation-1-eager-loading">Variation 1: Eager Loading</a>
                    </li>
                                    <li class="level-2">
                        <span>9.4</span>
                        <a class="internal" href="./chapter-9.html#variation-2-lazy-loading">Variation 2: Lazy Loading</a>
                    </li>
                                    <li class="level-2">
                        <span>9.5</span>
                        <a class="internal" href="./chapter-9.html#variation-3-constructor-params">Variation 3: Constructor Params</a>
                    </li>
                                    <li class="level-2">
                        <span>9.6</span>
                        <a class="internal" href="./chapter-9.html#variation-4-class-constructor-params">Variation 4: Class Constructor Params</a>
                    </li>
                                    <li class="level-2">
                        <span>9.7</span>
                        <a class="internal" href="./chapter-9.html#variation-5-call-the-lazynew-method">Variation 5: Call The lazyNew() Method</a>
                    </li>
                                    <li class="level-2">
                        <span>9.8</span>
                        <a class="internal" href="./chapter-9.html#variation-5a-override-class-constructor-params">Variation 5a: Override Class Constructor Params</a>
                    </li>
                                    <li class="level-2">
                        <span>9.9</span>
                        <a class="internal" href="./chapter-9.html#getting-services">Getting Services</a>
                    </li>
                                    <li class="level-2">
                        <span>9.10</span>
                        <a class="internal" href="./chapter-9.html#constructor-params-inheritance">Constructor Params Inheritance</a>
                    </li>
                                    <li class="level-2">
                        <span>9.11</span>
                        <a class="internal" href="./chapter-9.html#factories-and-dependency-fulfillment">Factories and Dependency Fulfillment</a>
                    </li>
                                    <li class="level-2">
                        <span>9.12</span>
                        <a class="internal" href="./chapter-9.html#setter-injection">Setter Injection</a>
                    </li>
                                    <li class="level-2">
                        <span>9.13</span>
                        <a class="internal" href="./chapter-9.html#conclusion">Conclusion</a>
                    </li>
                                        </ul>
        </div>
    </div>
</div>
</div>
</body>
</html>